package xmss

import (
    "bytes"
    "testing"
    "crypto/rand"
    "encoding/hex"
)

var (
    SHA2_10_256 uint32 = 0x00000001
    SHA2_16_256 uint32 = 0x00000002
    SHA2_20_256 uint32 = 0x00000003
)

func decodeHex(s string) []byte {
    r, _ := hex.DecodeString(s)
    return r
}

func Test_XMSS(t *testing.T) {
    t.Parallel()
    oid := SHA2_10_256
    prv, _ := GenerateKey(oid)
    pub := &prv.PublicKey

    params, _ := NewParamsWithOid(oid)

    var sig []byte
    msg := make([]byte, 32)
    rand.Read(msg)
    m := make([]byte, params.SignBytes()+len(msg))

    t.Run("sign_and_check_index", func(t *testing.T) {
        initIndex := make([]byte, params.indexBytes)
        copy(initIndex, prv.D[:params.indexBytes])

        sig, _ = prv.Sign(msg)

        afterIndex := prv.D[:params.indexBytes]
        if bytes.Equal(initIndex, afterIndex) {
            t.Error("XMSS test failed. The signature did not update the private key's index")
            t.Log("Init: ", initIndex)
            t.Log("After: ", afterIndex)
        }
    })

    t.Run("verify_generated", func(t *testing.T){
        if !Verify(pub, m, sig) {
            t.Error("XMSS test failed. Verification does not match")
        }

        sig[len(sig)-1] ^= 1
        if Verify(pub, m, sig) {
            t.Error("XMSS test failed. Flipped bit did not invalidate")
        }
    })
}

type testData struct {
    key string
    pub string
    sig string
}

var testDatas = map[string]testData{
    "SHA2_10_256": testData{
        key: "000000005a789fabe6c60249e307739c01c52a80cbccec2dcff3bfb1bc2428aff8eb91831dd38a73f0386d0a879613c1ec4b811715c9d0ea8403698538614250a6835b42f00aa5cc9b571a10ecfe3fc9b1ff0346a2973475441c85ef3ea07cdc0f6464109824f76af5437e4f5d1c4ad98c255015a0785acb466a0284ae97b70248fa58d5",
        pub: "9824f76af5437e4f5d1c4ad98c255015a0785acb466a0284ae97b70248fa58d5f00aa5cc9b571a10ecfe3fc9b1ff0346a2973475441c85ef3ea07cdc0f646410",
        sig: "00000000b2f085e01d2ec1a3d397921538ce3d4762e5d376c3c440b5369255ead0f0cd604dc5e0bb1ee1244b3f536b9b1185beb5d0cfedd90fd310403b9db471dfaa456e46446d946be3fdba9db7cfddea4aa10705fad34245b9f1db5c1d67202da87078d68ffabb791d043f02d24214ddcc08a99f22acb09050b907aa38efb4bbd323830b9d63f62c627fca6e564938e9a1176923c7a96cad8c1b33592c0edd0a2bebb7effd8747175f42c437708f55a95d2a291068b987a8b8d5e7cccab2ff46f63abee1f92476b03cd1fd620b19c9dee366d353903a7bcd57b41bea3a27873600e57299a3701b1ba54f8680ef581a130414963fdf25e0727ad96f096656e7a2badffa8789c7e60d6568cc96342898ab44bfb2878127b074ae3461139bd624a3a9d47b9279c0fbf91125793888e21f81f4f9fcf7c7fb2b58f721505d9dcc5e6f18ca390dbc77208403625b6795b7a3fdc75bc5bc084c67ec1fe33598ddbd05ab2b276bdafbf50dc82e6a4af9211e14c5f4312648e04a593768fc9d83634709c56c187482b29b384df422391dcfa0d3e97d38b5c4f3317158b9d665e39d6cd27c4d9acebb76fda812d7f716ca6ad0cd80ea97539eaafd3e8e7f26066fc393a2c8a2264d536571d39ae33cfa3ce8cf14249213c202353d0f5080f8a2239bc947e350754a0b43fd6b76af690b40fe198e5663e60b9d3e90b18dcae94959d69fd591e8e4875ca5f3cd44e00cffb715452c6aac637921bae247634a3593869af9688c52ab7859acdf89dc9f5130166b2a75754812eeab9e10ba8042bab258d415ceafc9a4328438d39292b02e972009fb726a3ed4e2a42b8c99f471058ad654faa7227089342ebd54814e4c00cd38305bf7bdaa8fb8edb5be4de456f59f4b66176025891083306df968d5b497f4a3049c27ccd8146333c943d3fb1c4ecaa9fea34f6c13330dced0a4db572daa5d4a8d4aa85115636359eef8be76c339fab2ba81ed2f830c86e97151bac46098eec34e0c1260c07e6cd28a5099ccbd7aab71b7d0e260880ffe69695d7fef0cde557283759332f44f17252b833a60eb896d2f08ee3d8d8088201baa1260753d979675e6e746769ab85b5208aebb7854ed7d8a1c03a1dc73474f5d13d965ad888b203c6df312ccac2a000843f4f5cf635c62cb4449f3402a8ed6a785598e19217c5a42f69fc7de4ec0545fab2761d6cbe7c5cdd9eb05fe258134e3c0948b0aa3e171544f5f9c61f3f17989aaed33e782968dd976e147f77f3482cf5941c4a9133d3f98cf209bfbac30037ab20f6c501b47d64849b1b31e7b1cfa9dff5467f4316b7b3465336184eb1c8d06b4d128ddee9f242d9e6e37036997e512ca3d47f223b2e37ba43cb25f9acc5890fc59602e42f64ecd38face5a2126b4e6a1b6d2213c80a702d53d36c8234aec0faf0001e61a1b4e2b061a47274287d4433c7975421b26cb22b25fd3aa218e92134ebea9b5924ad10d1bd0e29fae42139e59014ca7fcf8e4e891cb89e9ef9aba9c0829cecb19b87bc63f86a8f2b784ea6658baee840daf0bd4c0afee5616a65715204e170e26e8cc1985f3d43ea3948193eb27ea0813a516217e92ed5932c6bf9c779da0eeba8d5bdbe2a656be28a57e88d5e5bf1e2dd3af026e7071884149febf4e8d09b8981c310d7368d4b86586433ff6433f258257781398ee7ec791e9ce08b0cd870e26bf474eb44e9a2f704002a03c71786c76dc376fbe7dcac49c74d39cb76fadfb80dfecd71ce4dc9549de7b1ef02a5b525c1091dee1f77d5497d1338b5ec84e8a9732c8be9701f1d203b13bdf2503e38b04e4a925df6b9fed874e8f2fd92b1c2fed296dfbaf19a8532bed6a613f2c6b150406a551fdbaf45a3a419e6a5d3b02cd451447468755b259d24097cc7e799e8db60129797d43662e8c389c0167112f6618e593bfa21068b08c5112004e523bea8e8cd2a054d8a4b5faa07479f2bb411ebf74deaf112b5646fe5d8f47ab7fed6f9468b5628724de1b5f0a53999dfb6c161fdbbc3488d122b119937cfe596ddd2517203ec7e0bbd8d87b04c3f1a88f0776802337f4588655764d117cd537b9d148a3528629fb1dfcee608ed6aa0d12d169245d60d5b1c0f5cdf18a55491c21069fc1c0e8ab58e2a1ff05d2fb36dddc8d4c71ea36bc554fd12f8d45b16f63dcaf41256c1f80a238eb2ba7b6d6becbdc671a274f0ea7e65b4f13512df3581bb73cb040a65ee9b7f95e2f7652ae2820881eaa7a3cd89f81cd91a00ec21644e5612159877544c37c71468f4c702524cc39fbccae01c1e13af5c47d49d8f82a368c0be20174a3bbdaa164d9c3def89148628b2abcd548a6e77274cd4eca691f9291f20730881a284f613aeca0807f7f09a8caf555208a02539bef882b855764b1da366482d9ea5e0f7f48189df2226bf0812ba988f9370a0a9c2be87acd8f12dac4513cfd686484bcd41d2e006690238f7b35d5d6684257a2a426e99899a94b236a2248f2f14c1266ed6aee25e77db4d7275296d2d66b5ffadfb147e1774efdd6367e3f807d655e350f33e6cc4a86b907effc9d6f0a8e40e22cde7fdb1d9bd18aa1df60b85167c9e91310be55af67fa59f2173cb5d39289d1c270306c2464ca265478c8be3e24ec849c57ced795b214483d61bc529e84fc23cf77eaddb7646ead677581653d8060b6db351108e2e18a6887c68c5ba1b38542eb3dc5cc5bb69ad22cbe1d86ac21fc0b72ce43bc952723f2b05b733c56bf351f837586cb0c3c150f3d1f19b05162c524677ca4fcbffb5b9aea063a4edd35bf1aa887a3f8ebdf5f4cefc4c1c54a048b72bdc17b73544662bfd32643e24bfe552e5a8efe466b58dc8d9c92abdc1987e154c920b36fbef18278b1c7c3a43e001f3259ee1038af749e681c41e1d201a8a5b421d4f1d928d52be1b28e8783f3a4c2c013d8fb4cc2208f50ce4d0fa73c6fa6ca98fdb7f419869884122caead3bdac8d206dcd6429a1f1a5664a6050b24d64becdc9d8c84102080d90e05760547fb81bf35d49229f5e05f2fdff3c5f67c9e81c2f136f5370fea848e8d8582b340b5c2be63ba80de126f8bfd723a9c38b7b2fdcb5fc1dd66c5c9744bf988eada1e7e894868bf4a1fc5259357ae861e6a9e310a0333e254cb1ea126467a310cf8ee087fe0240b376575c32569807df088832ac9c82cc4f7515665f9cdb2b32983d0589db6d4881c42b6e7642d4528570ca116c504caa24657ecbb92bbdcfa0100ada6bf4d858d3cd588c56f1915e6522648d4878cde57dfaacede7d118b68501b4f0c4a8af5be544f445e92430f5481dc1973d0d65e7b52a0af25e3b0243090efa3ec4e1981e09cc6f99970d6a5a9361270c4cb1b027c2b82755a97d2c827857dca18be1c4bdfed51b261910d8fc8e496b75cae6bc3e93516acbdc905a8e5c2f6e5bcf7e73b343d4d47e18784e003628596db0c319a908561d8ead3631748e824764a3acb7cecf20cf1d6c54c8e209ed479d44b4c4f6f76c9cb37f5e2adb0951aa0b6eacd531e6e3b3b5d2095eaf8702244a20121c7df900b2e86ec2fe212bcda91576b0154460d38a4f8",
    },
    "SHA2_16_256": testData{
        key: "00000000b711367bb9d2e6cb266ba41599c2100e8f6b10cadb3ac524aea890dadd9d92b6159b1c5b74bb08072d660071219d01720a4decedcd85992b0ed6634f0d1f747965650fdaabb525feabe638748cd33b6589b4b44dc1eec72be8f6644beb433a25db56468902ea98951d7e7343eae890f5911615bba97b0bb07d548974dfbc6dca",
        pub: "db56468902ea98951d7e7343eae890f5911615bba97b0bb07d548974dfbc6dca65650fdaabb525feabe638748cd33b6589b4b44dc1eec72be8f6644beb433a25",
        sig: "0000000027a0bb4a42e4f51a67464b4e8733ac00fb1cc6910b40c187f0eceed0338c37c3991bfd67ff1c12ad22fcc3676c06e89b004fee559f5e61532a11cc8e697371501b19aaea1626790cb0a25bbea768a9e0b1b2e9fbbe7b7cbfaebf6d366b366f7e03c398e5a6a0ae81d48da6e5879166775b8602902bcbd4eac36e6549b14df3f76bbafa7c1547905277218d3837871a5528138d7797e097aea4c9f8a93a38d9c7682aef47db1d889957ca85cca57cfc619e5ce91f8dd3a08549d229f136ea621bdf5c4ea8fe70311172ffce94a577d149e3a9c6262c498245f49f94e55990075e51bdda3fa4b3188f1994a908ef07024e73bf8fa72afd170750c83064a58cb3b0a351f89467b3b5453a3d95ea16f9015d55afa5ee819b0f24aadb07d5e7b78d0c26a4eb52a782e89fabebbbb86dd10c39662f674f8b1ed42232cfe9a6861ca5f895a482c6cb7aa578c7f8d4d9117db879ed86eb334ff0d290196d624030c487c0695d405f3d48b614e5dc77c9fc32098b55e39c48db66ad478182eb0e253f50f5c8e495ffc518f14bd219033c6ccb9e17485398b17882a221c635fdf1b354968bbae982691874cfc3bc241fec58f83ac29baf32b6ce87aee3c04d08050c7950c20239a823553f79defa410d158626b9644f97cbfdf6f5c3f9cddc69899a0bca6c2a34b91570f800475c0f3881aed2581f54af2e902f9f93e4b27a9abff012db25e11608358941b4c057b592e6675cd575430f8c78a67bb8e8904117c73ecb1455e06feddb53c94ce269224ce0d891c9ed18e43d076f8a514943a9286f64d41a7aef5e085c93f03db1a93e0f8e435151bfc20387d2bc794dd7fc73413b1a11b29bd5fa9ad35af4bc93393840afe2b2d52d45874495d3ac70bddda0c1d662610630d6d35ecba04dd1519f7a1f71354ab968a002e9749ca78ec9a8b50a7103ac53ee9b6e070c806ef0c5d1de909e85494b07ada18654bb71a8d4a03b63f1f0088f3d9383c91d4533142326b583e9b7d8e63ea8da015bf91d58aaeed46e55e7263ca149fe8ad719bb39775f41f2ca8cc854b0ec74eeb2f81dd27a46bdbf9d7181c4a1fba29ba3463ccc603a240ae470924ee6ef2f6f9fb18e6099679078c264392f4ff61544cdc78c635a68bb9d2f18ad0677ce3065000b69eddf5b0865279966d08b97b6b508b3748a34168ed059fc71233f982afadecb75e8153fff6e6971b3df32724d743f5d11c1aebc9faa4ab4fc7116f69af9140437b6e73698a934d4d268466328d0658cffd5ab8710953792957be2c8f3c3edbd593e871589becf659ab9cf7e0daee7dd81aad569e63858c4868886e3249c98dac428f7bb778c8a79d7db78ad2073136689cbfa1f25a63e12dd0570dbd07f6f7decaa177f0e2246e8b408b05ced965688a76d817e5c91543ec8acdbc82512b9ba775be220fb23db0dac9c4250e9919d7cb80e658c802b97a28f5c7854c22814b611ccae76fbfd17a810f4e3b06a153639a768b7541fab9e07fb6796ebb897bb444ab56695d929156ce37de798b118f0e5518da6ce103cea7d552ba23e0884d1900e3193c2be17c4888760aa2bfa92a501db5dcf12ffaf012ef2fd375c9eb63996ddfe6853e65beca2e6ae327747ef59b4a536c63afc0fdc1f931f9ec1b2ceeb1670952af4018e13048c76c171075aeace3e76c4200c01e674a26faabf299754171e06c80d3365993907a59422606e65a6a2f75b417f9dfd087dacf04974c0536e55578fae5557a3462e78538e8f4442e1570de2d4c40bea610bc734dfd401858d615fee63fe7589a7fe35b3a44cc9427f2ccdbc974f5213554adca0567051d4f55bf6cfa3bc783b7f98c9aca1869621a5af15c61d20d8a1065f8caf7c531add967368a8158555536934985dcf66c76ba9cceb7fea406c340789b6aa4290bd9263975674ce9b2d3699ff8236f17e3872239a59ead75b0d8d9f852219383cd23799ea73aa076e980de5d9f748ee744098f9ffc5d13080fd1faba2fd40f75e112bc2f4626a82370712f925cea7102fae9a0d3c89a31e0dfe41a5dd94170de95470548b6c691e3ed8ee890b8dde41fa7953ea28b1d8918bd13ccea244ced4fe1585e3f84290565c9a1b6917280fe5f2208de35ff5695088330f0ea13c6aaf1eed4605e67177b8c0e786310cc23837f0abaca6ced4cb1047c8b3d3d226a213af155e208a60881d8b1373e63cb88ceac15ca4fb7ea650081aa3f801c21ee58d068c633f90a3c3a404e203ce5bcad59a9324d66938808f378c4d9062d6ec25374b5b12ebc1ad5e1b258b868550aec9ef41e9c09d93c92213005eb9180d8d1aff4a000fc18537cc3d18ec0fb055cfc643e07665645b449326a6b859bf541f616dbfa39f929d6b709457f73dc762b5cd22d73ee6c7a23baa581f103d286ffc87abee3bcc2a6cb9d7f9ba4b7693b6ba9cd976b24a6a411f233243f3a54cf045e8b07bdee17137ffa4ebf7d7956f45cd2c5379cec91585f7ba01db7a6b63870d747d8c77a7db24136d23b560d32a0b758d3a423e8eb0fda4bf1676d7fc5df927e2d338ce88944d2e063fdfb369b5126f7af95ebeaa4eb0739184054246aacbf0ba9239f75582f12eaf07a93c5293a9ba72f1a1e13cf96ad065b2bd522c387b778255e15a6c66fe79a93b02c40e753968a04378d220a4a6028ee1f1f6851cb91eb5465694de8552cbc391d15a506df25564ca4a90b5c9163d455e117a2909660d460ea72628c6c197539849799b6f5576aeee3a92c12bb7745ae0abb0f4ce89281edf9d36d49e9576fb6bc1b1947171416b6baa8049ae1b1ed359f67931884c3a34c89d5ee7896ed46274a03b25814db4d076914c85d25a553db261054d5397bbfa05df82a774cdd147d6cb728b556d0f48d5ad056bfe620370ebc79e8bde12553dd6f6dfe2a2a43a04c9672383acf9465ef3c6237835411bf380b64a3544baa902fd3b5b761529311fb247603178024a4239d34908ffefa8f5e594490506332b9b092bb9e80d56a9ffeb39d5be05f4c1f5bfc40abf038395a29d2d8acd5cd3cdea952a9cf6120491a5d67fa92bc577ed835ca7ff8ef76e09cbf403628ec998e13189016372deaead53d95f9a5227999a7bfdb99a2f180a1ace411f19675824612a02dda7ff5a1f37a55d4ade013c2babf76d73bbcf270d552fe9de6cf0e7c8b5673c302bdacd8fcf3b6df1642885c494b06c89ba2a07fb7848666e27313298d7856e38f34fbea7c6c94eac448fc068fd89266d6e749e1bad951ba30d528a395efdcf982a657a1b26e47187a98d07457c23e20f4dec9eb09b8584824cdbd43f7369aca5d6b383f45b0c1817497756a56726712d466a2d162cdedd9ec556f061eefc40d9790e1312e0f3074f3b80886080e4259bcb7c278f44bf7a45cd90c47a39daee34ac28bcf197e02ded83ec089b5f31d72fece359a6bedf7e3b4caa0e5d2b291791b9948c31105e2b0168a22d1248c696e9c188c156e727c84bff35f5a42aabfb6c93f2b7ea590d339d30b5db245740f4172e582abbaf45bce4882d62663fcd47ebc9de5bbcbaa52ceadad69669baa82010ad5a87b0e3af89243711405ce9eb68337772296c7d73737effeb9845164764e6a8e2e9f7471896c6638b3dfd10393d2777e5d18b2e49ec5781ccd2e1ed190a4c3c091e3982147f556bea2d87f7732699ad79ec794df2ded3feada6323b4cd94ba69bed9be1aa60f560861811334762baf02a9ae08efed8d9dca3ea4e0d0b7daeb375c20d1eb0ea9066708a3cefa86a334e2de1cce054f2ac3c906afe47de2095eaf8702244a20121c7df900b2e86ec2fe212bcda91576b0154460d38a4f8",
    },
    "SHA2_20_256": testData{
        key: "00000000fcf24b1a68382baaae089c9895bc0f337681544c53383be534dcade37b85c86b3e658d84496f0e6a65fd7ac7915673947d8cc4bf82f0abe75ad16a2881807660f5f604711758114f09462da9b8ed11c61fd28009ee4ee0fbc3c38ea1e19397ccce83f1f8f9a8263ea0bc3a4bc9ce6ebab9426e3b20a999f30152364dcb397f83",
        pub: "ce83f1f8f9a8263ea0bc3a4bc9ce6ebab9426e3b20a999f30152364dcb397f83f5f604711758114f09462da9b8ed11c61fd28009ee4ee0fbc3c38ea1e19397cc",
        sig: "000000009dbc75479bf03e73752ba0de41a8374180e4dbc6c0b71b190cae1cfeab500005ac528d2e333a76371e706fc2eb459032a54377d9162e534234e5591a23b6e7f7816eb415b81ffed3e374d5c1415ad4154939d764a0b43d6c6e557e6d20109085b986080df0cd93b98ec873607fe87ed589d938457ac6083733a938b9a988295588c29f665966793cb69a49221ae94607c063fff1b7285546ee561321164a385ebe2cc5771d7637dcf09cf6bbfc11da1aa402d929f6519347c139afc854e038c38ed08390738f78d394a533c44fbeb33270c3b3e17ad768eb799cfcb06bc841eca201fb4f5544b12cd8cf49555d121fc1908e42d77796637a93be31b5f26630bf19bfc2761e01df11c7e8635e22aa9fbc43a6981b8502c02b845df87d34b315d19173605d2ce66fae1cdd2c3b206b27108417a34fa62cf6ccd199080e540120a7e5967ae337ed41dc139d40383f23770a18834fd20ec9fb637d318e285db659b0a0cd045602111c6d9321258ee339f1fedb16951405374d53612d9769d430d3818e99e1f200d91707bb301dcefb2ab1738cb0942d392ec00e162f21e5ab6b8fb978d22bb2beca0c55f3b9eeef2a4203c7b4daf2ccdf7dd3023157b1736926c400afd9dad9fc16c2e9662c33b051b14ff78d164c2fd204ef864bd8c10ad113640ed75df6109f1b2c874be663a87b223c40e96c8c550012fd7dc28902946e26104559ca7cf65d943aced517db1d5f5ca667dbdf26c3005871254f060df730dbbc074b19e06152d655c654a606d34ca3916f1f42ffec76f397d42ce2e235e1b2bf7623fdbfc3ea0c106fa5299c231520a295f840f9f2d77edde4ecfd11b5106fc2b066e61fa730cd6f2739021ce7fb1efa19bba273595a0f626c47bd9151e9021e988c76cdb80bbea654c743675a0b5ed69dc36ab0ec0d73ff9caa42d3e5ad359afaa650d376b57ec9213b7a5b45a4bbf93d1968e3bc5b58bf67616e1b869bc0cf9352f0dde7c0dcace72467b5e188e1829afa72edaf48ecf5dd8c62880d77fa1e301db71d4fdc775ba3c7f305b104f46bc9491e4960d41aa8c0edc3c5d27b2e5ecbc716b8bbde442ec48c7eac952ea578d1a0faf2b635da34878223b1adbd2a83de7f40c488baa28dc5a7a51a6b0ab6b89f3349bae61186e1aa325f6b9d62bd123934cd30e166ef4a4845837035e3fd0c355557ab974db7435ed5baa0b98f4daae3f816233df41ac692e4670b8c0409f1cd443612d0859cd9778da52942fc61a2c96430c254aa25276ae8c500f445d75779107cfcc6e1e6569c3b40fb4072831a2d7d6a2cf43c55ffadf4a83a772b3adfd6da5a7330a5955503f84138b65750047ef6128b10525f27fa796630f8baa3a07eef4bc057a3a1eb7659c959304f27756b9e578b2fa40a5d256ed87e842726d3713dde685c76a3df531d70707048e6cdc75a17b30783140592a4e9ec79b14ede167ef9321e9c36e3c7700dcf74a44a77f97b29e67dc2d9e3971d198ac0d0fa4c7a20fa44479f8476bd12a01ef401d3518ad89da8d8779e477d108a82e2fc1b07bd8235fec5ff88f831dcebc4e6854d9d2787e4b1c0e94f2af10c04a6edf0e9b8048dbb5db10ca6bfff3d2d86b861f8ae892674ad474eac7220ffc935a84ed19618b5b40616f5f1ddd86aa16a40a2177211869c974e981c8dfab57cac517422c0b8cb56bd0bf08e06f46f041cdb387f68e88f14e7b97f3c235fda8d611e64a262a6af962633c9e18434ae4060459a1fcc071533df72214e8a82a90de6e78aef9fcf8c4d75257725d8200d4299a0672c605dcc68489402674c8f253c11a5b0592dc051e473d9494424f5a25d88dfd40467fba717cbd45cdb1a2dfcc2c1c6dc05618f81072a76d52b481d1428a56bd492baf77fccb6f4a940ef1efccde9ba83d096dd4e8a999d54896b8c19733063507fd901cf97556006db7d33e261c894ef6fb11c547b4313094051aee438c21bd587047f9b29534324d34192d73df806e51e1d41c930e94d9a6da3280cb4a0f183292466cefcff3182497c0187aa04ae2dadaae45aeed5f722ff9627a9d6ad45e6c4537ea02d6171bb84fbab229cd4ccfd07a19f720b4bf4e6c637124edfbe553d4751ea6aac6c2e00e1d84d415ae234b1b9adf6af3f628da71c211a41b23836d39cf45767155c71e26a0696717640f34e1dcc8b6b261d96625c23ad547ce501152677abc76e380b71006a1f57c76aaf94a1ca9e268ee229bfa55e134cd03e63b8637c8af20e4b530b7f696b98c1e0278be94991f8c31f2f20aee7cfc9605d878d882aa9d6fab0446f966350812cec5ebdefdd22a79f081723e2dd81cdb4a70cd6d6c1c4963e143c429c9d0dff4e02033a0e739ac6668866f79db98464c36e562b35f7667c178e4dee804995b5277388e9504afeb3725aabf11a7a01c55a98adefc50dcb73df5f6ebd68d414e669c36680ce05cee0af3bacaeed10ca04b570feac871a56b35d1492209362f509f1c296c2af557cd5a672f98b00629b57ab6c7d7546cbe5a84d44a54e09dff4ca5bee91145093f38a957713fdf21ad68b6eacdf7fe518af5867797afc848a1da79131e6c8c4a874491684653566f2a60c84f65d7633ba14fdec5f77590954d2e70337571a9b291f19bfcf9350c3eedc0d723b6d5f8d75560f184e76d7d2169a9eb2da19ad7ee9985b9712aca491e4ea0f1103d7c835a857b2ffe3e9dc17e388bc79a110e4ef285c785b2ed447488f76e5d15ffe1b212af2237abc95b8ecd912528e1d24765a285c6d27a5bd6c870ea1c5e4750a607a79c97cde1e0d5ff73f85d2e6276facc5e32282bb0ab8ec84b7f011db130d0ada740bc38678a6ec1da2eac557f1027e1d517eeceaebcbd8115f0fe7d65304c696b86ef9b08a9198074b24f862218203dbf45ee636e441a2c0d444c957114fb805d3f2db79e99fadf8c5452f06062bfed5681682270121123c7af1c22d6d3cd1bfd6e1f16c9658d07a095963e501379489c4530ae3eee963c1e5ee18e2b8c2b9fbb9d57ff3705873887942a28acaaf1af68ff7c517aeb822c2998ccb07ff4ed93a956ec64c72d04bdfbbd6b6b38bc5df8386b3c1c933543668b26055f82830983977d41d77399683d5c7c6b74c87e07e3d5b41b9cd7211848547a53400e90f56b80e93447408480372c1ed3a65a4268a9e963fb1189b01c69808345b755bf4932cfea0adbcdeb75ed0f2f5aa0a5537e75c6ed333a2e6ed9da49d9962769c94fa723bc60aa49adf3a8692d5d265bd9b713531f730ee574c5b826a2abdf42747914f8ebf6de30f499ed233e351645e1a3b100463636bce7f120706bf55ab7a88323d1a9f694b086f94992af56b01d249dfc9caf99560910a9d1782fc84a3bb2062a655c9d6f9820de049cd700f16b962126290187a8b870626a8d691fcccbd4ecd1fbb31ed939bd9583c448f1f5f5b7818a7d6c6b7b06de0e8c33f4936983437249e92c7a7a3550eb81681cd35959bd2f6459b2cf86ad2823114a08320687a3e021fb23c947793b350e9163d53cbe526dfcc66efbf95b136091863dbde61a3567b4d646e8342fe9c226024926716c8b327b1fe9f8b4f694e0fa1b6906ea361094a2694278500d6f82d15c0c4be951fa436e4aa90c5fa2a85f3a76ab59e5d91b34adf3ef8b5e83dbe6deb7c21ac7917c0fe40d94596df9367f602ad20954d1343ee9d3c7ecfa0c28679a9e7fc7dc9c39c69a41e5e2b5d602e38a718265dc1193ab85581e1e9af8584f26546048a6a261195a3204c214a4f4334d1477bb8fb3288a560b46e1c437ad62dd51f2963c5cd46e3b966a973315851a4ce793445a5ca5709b4b977c123cd04762efc53bb96324452932bcb15b01ea0480fb1ac3c5d3f443e60dffd55fb55c5ffa4c249e15b0fc2806df5721b38c7da585be2a71004a979d7686afeef6d23e9de39bcac1e8727cf0f2cc1e88ebe997821c9cff87a3b72356d3f6fd52095eaf8702244a20121c7df900b2e86ec2fe212bcda91576b0154460d38a4f8",
    },
}

func TestVerify(t *testing.T) {
    t.Parallel()
    testParams := map[string]uint32{
        "SHA2_10_256": SHA2_10_256,
        "SHA2_16_256": SHA2_16_256,
        "SHA2_20_256": SHA2_20_256,
    }

    message := "2095eaf8702244a20121c7df900b2e86ec2fe212bcda91576b0154460d38a4f8"
    msg := decodeHex(message)

    for name, oid := range testParams {
        t.Run(name, func(t *testing.T) {
            t.Parallel()
            var pub *PublicKey = &PublicKey{}
            var sig []byte

            data := testDatas[name]

            pub.X = decodeHex(data.pub)
            pub.Oid = oid
            pub.Precompute()

            sig = decodeHex(data.sig)

            params, _ := NewParamsWithOid(oid)

            m := make([]byte, params.SignBytes()+len(msg))
            if !Verify(pub, m, sig) {
                t.Error("XMSS test failed. Verification does not match")
            }

            sig[len(sig)-1] ^= 1
            if Verify(pub, m, sig) {
                t.Error("XMSS test failed. Flipped bit did not invalidate")
            }
        })
    }
}
